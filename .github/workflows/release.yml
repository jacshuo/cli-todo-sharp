# Builds standalone binaries for all platforms and creates a GitHub release.
#
# ── Trigger modes ────────────────────────────────────────────────────────────
#
# 1. workflow_dispatch – manual run from the GitHub Actions UI.
#      version input filled in  (e.g. "1.1.0" or "v1.1.0")
#        → tag: v1.1.0 | proper release | notes from CHANGELOG.md [1.1.0] section
#      version input left blank
#        → tag: top versioned entry in CHANGELOG.md (first ## [x.y.z] block)
#           proper release | notes from that CHANGELOG.md section
#
# 2. push to master  (source changes only)
#        → tag: build-YYYYMMDD-<sha7> | pre-release | generic commit body
#
# ── Assets ───────────────────────────────────────────────────────────────────
#   todo-win-x64.exe  |  todo-linux-x64  |  todo-osx-x64  |  todo-osx-arm64
#
# Windows binary is Authenticode-signed when the two repository secrets are set:
#   Base64_Encoded_Pfx  –  base64-encoded .pfx certificate
#   Pfx_Key             –  .pfx password

name: Release Binaries

on:
  workflow_dispatch:
    inputs:
      version:
        description: >
          Release version, e.g. "1.1.0" or "v1.1.0".
          Leave blank to auto-detect from the top versioned entry in CHANGELOG.md.
        required: false
        default: ''
  push:
    branches: [ "master" ]
    paths:
      - 'src/**'
      - 'tests/**'
      - '**.csproj'
      - '*.sln'
      - 'global.json'
      - 'Directory.Build.props'

permissions:
  contents: write   # required to create GitHub releases

env:
  PROJECT: src/CliTodoSharp/CliTodoSharp.csproj

jobs:
  # ── Resolve version / tag / release-type before the matrix build starts ───
  # Outputs are consumed by both the build and release jobs so the version
  # string is embedded in every binary AND used as the GitHub release tag.
  prepare:
    name: Resolve release metadata
    runs-on: ubuntu-latest
    outputs:
      tag:          ${{ steps.meta.outputs.tag }}
      version:      ${{ steps.meta.outputs.version }}
      prerelease:   ${{ steps.meta.outputs.prerelease }}
      release_name: ${{ steps.meta.outputs.release_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve metadata
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # CI push ─ build-date-sha pre-release
            SHORT_SHA="${GITHUB_SHA:0:7}"
            DATE="$(date -u +%Y%m%d)"
            TAG="build-${DATE}-${SHORT_SHA}"
            # Use a valid SemVer pre-release string so MSBuild accepts it
            VERSION="0.0.0-build.${DATE}.${SHORT_SHA}"
            echo "tag=${TAG}"                    >> "$GITHUB_OUTPUT"
            echo "version=${VERSION}"            >> "$GITHUB_OUTPUT"
            echo "prerelease=true"               >> "$GITHUB_OUTPUT"
            echo "release_name=Build ${TAG}"     >> "$GITHUB_OUTPUT"
          else
            INPUT="${{ inputs.version }}"
            if [[ -n "$INPUT" ]]; then
              VERSION="${INPUT#v}"
            else
              VERSION=$(grep '^## \[' CHANGELOG.md \
                          | grep -v '\[Unreleased\]' \
                          | head -1 \
                          | sed 's/## \[\([^]]*\)\].*/\1/')
            fi
            if [[ -z "$VERSION" ]]; then
              echo "::error::Could not determine version. Add a versioned section to CHANGELOG.md or supply the version input."
              exit 1
            fi
            echo "tag=v${VERSION}"              >> "$GITHUB_OUTPUT"
            echo "version=${VERSION}"           >> "$GITHUB_OUTPUT"
            echo "prerelease=false"             >> "$GITHUB_OUTPUT"
            echo "release_name=v${VERSION}"     >> "$GITHUB_OUTPUT"
          fi

  # ── Build one self-contained binary per platform ───────────────────────
  build:
    name: Build ${{ matrix.rid }}
    needs: prepare
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - rid: win-x64
            os: windows-latest
            bin: todo.exe
            asset: todo-win-x64.exe
            sign: true
          - rid: linux-x64
            os: ubuntu-latest
            bin: todo
            asset: todo-linux-x64
            sign: false
          - rid: osx-x64
            os: macos-latest
            bin: todo
            asset: todo-osx-x64
            sign: false
          - rid: osx-arm64
            os: macos-latest
            bin: todo
            asset: todo-osx-arm64
            sign: false

    env:
      HAS_SIGNING_CERT: ${{ secrets.Base64_Encoded_Pfx != '' }}
      OUT: publish/${{ matrix.rid }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Publish ${{ matrix.rid }}
        run: |
          dotnet publish ${{ env.PROJECT }} \
            -c Release \
            -r ${{ matrix.rid }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:Version=${{ needs.prepare.outputs.version }} \
            -o ${{ env.OUT }}
        shell: bash

      # ── Windows code signing ─────────────────────────────────────────────
      - name: Decode signing certificate
        if: matrix.sign == true && env.HAS_SIGNING_CERT == 'true'
        env:
          PFX_B64: ${{ secrets.Base64_Encoded_Pfx }}
        run: |
          $bytes = [System.Convert]::FromBase64String($env:PFX_B64)
          [IO.File]::WriteAllBytes("$env:RUNNER_TEMP\signing.pfx", $bytes)
        shell: pwsh

      - name: Sign executable
        if: matrix.sign == true && env.HAS_SIGNING_CERT == 'true'
        env:
          PFX_KEY: ${{ secrets.Pfx_Key }}
        run: |
          $signtool = Get-ChildItem `
            'C:\Program Files (x86)\Windows Kits\10\bin' `
            -Recurse -Filter signtool.exe |
            Sort-Object FullName -Descending |
            Select-Object -First 1 -ExpandProperty FullName

          & $signtool sign `
            /fd  sha256 `
            /td  sha256 `
            /tr  http://timestamp.digicert.com `
            /f   "$env:RUNNER_TEMP\signing.pfx" `
            /p   "$env:PFX_KEY" `
            /v   "${{ env.OUT }}\${{ matrix.bin }}"
        shell: pwsh

      - name: Remove signing certificate
        if: matrix.sign == true && env.HAS_SIGNING_CERT == 'true'
        run: Remove-Item -Path "$env:RUNNER_TEMP\signing.pfx" -Force
        shell: pwsh

      # ── Rename to asset name and upload ──────────────────────────────────
      - name: Rename binary
        run: |
          cp ${{ env.OUT }}/${{ matrix.bin }} ${{ env.OUT }}/${{ matrix.asset }}
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset }}
          path: ${{ env.OUT }}/${{ matrix.asset }}
          if-no-files-found: error

  # ── Create GitHub release with all four binaries ──────────────────────────
  release:
    name: Create Release
    needs: [prepare, build]
    runs-on: ubuntu-latest
    env:
      NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

    steps:
      - name: Checkout (needed for CHANGELOG extraction)
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      # ── Build release body ────────────────────────────────────────────────
      # Versioned releases: extract the matching section from CHANGELOG.md.
      # Build tags: emit a generic commit-based message.
      - name: Build release notes
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          PRERELEASE="${{ needs.prepare.outputs.prerelease }}"

          if [[ "$PRERELEASE" == "false" ]]; then
            # Extract lines between  ## [VERSION]  and the next  ## [  heading.
            awk "/^## \[${VERSION}\]/{found=1; next} \
                 found && /^## \[/{exit} \
                 found{print}" CHANGELOG.md \
              | sed '/^[[:space:]]*$/d;/^---$/d' \
              > release_notes.md

            if [[ ! -s release_notes.md ]]; then
              echo "Release v${VERSION}." > release_notes.md
            fi
          else
            cat > release_notes.md << 'EOF'
          Automated build from commit ${{ github.sha }}.

          **Binaries** — self-contained, no .NET runtime required:

          | File | Platform |
          |---|---|
          | `todo-win-x64.exe` | Windows x64 |
          | `todo-linux-x64`   | Linux x64 |
          | `todo-osx-x64`     | macOS Intel |
          | `todo-osx-arm64`   | macOS Apple Silicon |

          Run `chmod +x todo-*` on Linux/macOS before first use.
          EOF
          fi

      # ── Pack NuGet and push ───────────────────────────────────────────────
      # For PackAsTool exe projects the SDK runs an internal publish during
      # 'dotnet pack', which requires build artifacts to already exist.
      # Running restore → build → pack --no-build avoids the clean-tree failure.
      - name: Restore
        run: dotnet restore src/CliTodoSharp/CliTodoSharp.csproj

      - name: Build (for pack)
        run: >
          dotnet build src/CliTodoSharp/CliTodoSharp.csproj
          --configuration Release
          --no-restore
          -p:Version=${{ needs.prepare.outputs.version }}

      - name: Pack NuGet
        run: >
          dotnet pack src/CliTodoSharp/CliTodoSharp.csproj
          --configuration Release
          --no-build
          --no-restore
          -p:Version=${{ needs.prepare.outputs.version }}
          --output nupkgs

      - name: Push to NuGet
        if: env.NUGET_API_KEY != ''
        run: |
          dotnet nuget push "nupkgs/*.nupkg" \
            --api-key "$NUGET_API_KEY" \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate

      # ── Publish the release ───────────────────────────────────────────────
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name:   ${{ needs.prepare.outputs.tag }}
          name:       ${{ needs.prepare.outputs.release_name }}
          prerelease: ${{ needs.prepare.outputs.prerelease }}
          body_path:  release_notes.md
          files: |
            artifacts/todo-win-x64.exe
            artifacts/todo-linux-x64
            artifacts/todo-osx-x64
            artifacts/todo-osx-arm64
